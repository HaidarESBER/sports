---
phase: 04-sessions-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/app/api/sessions/route.ts, src/app/api/sessions/[id]/route.ts, src/app/api/exercises/route.ts]
autonomous: true
---

<objective>
Create Session and Exercise CRUD API endpoints for the backend foundation.

Purpose: Provide REST API for session management (create, read, update, delete) with proper authentication and authorization.
Output: Working API endpoints at /api/sessions and /api/exercises that integrate with Prisma models.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-models/02-01-SUMMARY.md
@.planning/phases/03-authentication/03-01-SUMMARY.md

@prisma/schema.prisma
@src/lib/auth.ts
@src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sessions API routes (list, create)</name>
  <files>src/app/api/sessions/route.ts</files>
  <action>
Create /api/sessions endpoint with GET and POST handlers:

**GET /api/sessions**
- Use `auth()` from @/lib/auth to get current user session
- Return 401 if not authenticated
- Query prisma.session.findMany() with:
  - where: { authorId: session.user.id }
  - include: { exercises: { include: { exercise: true } } }
  - orderBy: { updatedAt: 'desc' }
- Return 200 with sessions array

**POST /api/sessions**
- Use `auth()` to get current user
- Return 401 if not authenticated
- Accept JSON body: { name, description?, sport, estimatedDuration? }
- Validate required fields (name, sport)
- Create session with authorId from session.user.id
- Return 201 with created session

Use Next.js App Router route handlers pattern:
```typescript
export async function GET(request: Request) { ... }
export async function POST(request: Request) { ... }
```

Import auth from "@/lib/auth" and prisma from "@/lib/db".
  </action>
  <verify>
- `npm run build` succeeds
- File exists at src/app/api/sessions/route.ts
- Exports GET and POST functions
  </verify>
  <done>GET /api/sessions returns user's sessions, POST /api/sessions creates new session</done>
</task>

<task type="auto">
  <name>Task 2: Create Session detail API routes (get, update, delete)</name>
  <files>src/app/api/sessions/[id]/route.ts</files>
  <action>
Create /api/sessions/[id] endpoint with GET, PUT, DELETE handlers:

**GET /api/sessions/[id]**
- Use `auth()` for authentication (401 if not logged in)
- Get session by id with exercises included
- Return 404 if not found
- Return 403 if session.authorId !== user.id (only author can view for now)
- Return 200 with session data

**PUT /api/sessions/[id]**
- Authenticate user
- Get session, verify ownership (403 if not author)
- Accept JSON body: { name?, description?, sport?, estimatedDuration?, exercises?: SessionExerciseInput[] }
- Update session fields
- If exercises array provided, replace all SessionExercise records:
  1. Delete existing: prisma.sessionExercise.deleteMany({ where: { sessionId } })
  2. Create new: prisma.sessionExercise.createMany({ data: exercises.map(...) })
- Use transaction for atomicity
- Return 200 with updated session

**DELETE /api/sessions/[id]**
- Authenticate user
- Verify ownership (403 if not author)
- Delete session (cascades to SessionExercise via schema)
- Return 204 No Content

Route params accessed via context.params in App Router:
```typescript
export async function GET(
  request: Request,
  context: { params: Promise<{ id: string }> }
) {
  const { id } = await context.params
  ...
}
```
  </action>
  <verify>
- `npm run build` succeeds
- File exists at src/app/api/sessions/[id]/route.ts
- Exports GET, PUT, DELETE functions
  </verify>
  <done>Session detail endpoint supports get, update, delete with ownership check</done>
</task>

<task type="auto">
  <name>Task 3: Create Exercises API route (list, create)</name>
  <files>src/app/api/exercises/route.ts</files>
  <action>
Create /api/exercises endpoint with GET and POST handlers:

**GET /api/exercises**
- Public endpoint (no auth required) - exercises are shared resources
- Accept optional query params: ?sport=running&search=tempo
- Query prisma.exercise.findMany() with:
  - where: { sport: sport (if provided), name: { contains: search } (if provided) }
  - orderBy: { name: 'asc' }
  - take: 50 (limit results)
- Return 200 with exercises array

**POST /api/exercises**
- Require authentication (401 if not logged in)
- Accept JSON body: { name, description?, sport }
- Validate required fields (name, sport)
- Check for duplicate: existing exercise with same name AND sport
- Return 409 if duplicate exists
- Create exercise
- Return 201 with created exercise

Note: Exercises don't have authorId - they're shared resources that can be used in any session. Future phases may add exercise ownership if needed.
  </action>
  <verify>
- `npm run build` succeeds
- File exists at src/app/api/exercises/route.ts
- GET /api/exercises returns exercise list
- POST /api/exercises creates exercise (authenticated)
  </verify>
  <done>Exercise API supports listing with filters and authenticated creation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] GET /api/sessions returns 401 when not authenticated
- [ ] POST /api/sessions creates session with current user as author
- [ ] GET /api/sessions/[id] returns session with exercises
- [ ] PUT /api/sessions/[id] updates session and exercises
- [ ] DELETE /api/sessions/[id] removes session
- [ ] GET /api/exercises returns exercises list (public)
- [ ] POST /api/exercises requires authentication
</verification>

<success_criteria>
- All tasks completed
- All API endpoints functional
- Authentication enforced where required
- Ownership checks prevent unauthorized access
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-sessions-core/04-01-SUMMARY.md`
</output>
