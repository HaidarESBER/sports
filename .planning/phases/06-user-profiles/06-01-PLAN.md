---
phase: 06-user-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [prisma/schema.prisma, src/app/api/users/[id]/route.ts, src/app/api/users/[id]/follow/route.ts, src/app/api/users/[id]/followers/route.ts, src/app/api/users/[id]/following/route.ts, src/app/api/profile/route.ts]
autonomous: true
---

<objective>
Implement User Profiles backend with Follow system.

Purpose: Enable public user profiles and social connections (followers/following) that form the foundation for the discovery and social features in later phases.
Output: Database schema with Follow model, profile API endpoints, and follow/unfollow API endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@prisma/schema.prisma
@src/lib/auth.ts
@src/lib/db.ts
@src/app/api/sessions/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile fields to User and create Follow model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add to User model:
- bio: String? (user description, max 500 chars enforced at API level)
- location: String? (city/country)
- isPublic: Boolean @default(true) (profile visibility)

Create Follow model for followers/following relationship:
- id: String @id @default(cuid())
- followerId: String (user who follows)
- followingId: String (user being followed)
- createdAt: DateTime @default(now())
- follower: User relation
- following: User relation
- @@unique([followerId, followingId]) to prevent duplicate follows

Add relations to User:
- followers: Follow[] @relation("UserFollowers")
- following: Follow[] @relation("UserFollowing")

Run `npx prisma db push` after schema changes.
  </action>
  <verify>npx prisma db push succeeds, npx prisma generate succeeds</verify>
  <done>Follow model exists with unique constraint, User has bio/location/isPublic fields and follower relations</done>
</task>

<task type="auto">
  <name>Task 2: Create profile API endpoints</name>
  <files>src/app/api/profile/route.ts, src/app/api/users/[id]/route.ts</files>
  <action>
Create GET/PATCH /api/profile for current user's own profile:
- GET: Return current user's profile (requires auth)
- PATCH: Update bio, location, name, isPublic (requires auth, validate bio <= 500 chars)

Create GET /api/users/[id] for viewing any user's public profile:
- If profile isPublic=true OR viewer is the profile owner: return full profile with stats
- If profile isPublic=false AND viewer is not owner: return 404
- Include counts: _count.followers, _count.following, _count.programs (public only), _count.sessions

Return format:
{
  id, name, image, bio, location, isPublic, createdAt,
  stats: { followers, following, programs, sessions },
  isFollowing: boolean (if viewer is authenticated)
}

Use existing auth() pattern from sessions API. Return 401 for protected endpoints without auth.
  </action>
  <verify>curl -X GET /api/profile returns current user, curl -X GET /api/users/{id} returns public profile with stats</verify>
  <done>Profile endpoints work for viewing and updating profiles, respects isPublic setting</done>
</task>

<task type="auto">
  <name>Task 3: Create follow/unfollow API endpoints</name>
  <files>src/app/api/users/[id]/follow/route.ts, src/app/api/users/[id]/followers/route.ts, src/app/api/users/[id]/following/route.ts</files>
  <action>
Create POST/DELETE /api/users/[id]/follow:
- POST: Follow user (create Follow record). Requires auth. Return 400 if already following or self-follow.
- DELETE: Unfollow user (delete Follow record). Requires auth. Return 404 if not following.
- Both return { success: true, isFollowing: boolean }

Create GET /api/users/[id]/followers:
- Return paginated list of followers (users who follow this user)
- Query params: page (default 1), limit (default 20, max 100)
- Return { followers: User[], total, page, totalPages }

Create GET /api/users/[id]/following:
- Return paginated list of following (users this user follows)
- Query params: page (default 1), limit (default 20, max 100)
- Return { following: User[], total, page, totalPages }

For followers/following lists, only show if profile isPublic=true OR viewer is owner.
  </action>
  <verify>curl POST/DELETE /api/users/{id}/follow toggles follow state, curl GET followers/following returns paginated lists</verify>
  <done>Follow/unfollow works, followers and following lists are accessible with pagination</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma db push` succeeds
- [ ] `npm run build` succeeds without errors
- [ ] GET /api/profile returns current user
- [ ] PATCH /api/profile updates bio/location
- [ ] GET /api/users/{id} returns public profile with stats
- [ ] POST /api/users/{id}/follow creates follow relationship
- [ ] DELETE /api/users/{id}/follow removes follow relationship
- [ ] GET /api/users/{id}/followers returns paginated list
- [ ] GET /api/users/{id}/following returns paginated list
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Follow system works end-to-end via API
- Private profiles return 404 to non-owners
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-profiles/06-01-SUMMARY.md`
</output>
