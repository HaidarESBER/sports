---
phase: 05-programs-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/app/api/programs/route.ts, src/app/api/programs/[id]/route.ts, src/app/api/programs/[id]/sessions/route.ts]
autonomous: true
---

<objective>
Create REST API endpoints for Programs CRUD with session scheduling.

Purpose: Enable creation and management of multi-week training programs that compose sessions into a weekly calendar structure.
Output: Programs API following established patterns from Sessions API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior patterns to follow
@.planning/phases/04-sessions-core/04-01-SUMMARY.md

# Existing code to follow patterns from
@src/app/api/sessions/route.ts
@src/app/api/sessions/[id]/route.ts

# Schema reference
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Programs list and create API routes</name>
  <files>src/app/api/programs/route.ts</files>
  <action>
Create REST API for Programs collection:

**GET /api/programs**
- Authenticated: returns user's programs with nested programSessions (include session data)
- Order by updatedAt desc
- Return 401 if not authenticated

**POST /api/programs**
- Authenticated: creates new program
- Required: name (string, non-empty), sport (string, non-empty), durationWeeks (int, >= 1)
- Optional: description (string), difficulty (string), isPublic (boolean, default false)
- Set authorId from session.user.id
- Return 201 with created program
- Return 400 for validation errors, 401 if not authenticated

Follow exact patterns from src/app/api/sessions/route.ts:
- Use auth() from @/lib/auth
- Use prisma from @/lib/db
- Same error response format { error: "message" }
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>GET /api/programs returns user's programs, POST creates new program with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create Program detail API routes (get, update, delete)</name>
  <files>src/app/api/programs/[id]/route.ts</files>
  <action>
Create REST API for single Program operations:

**GET /api/programs/[id]**
- Authenticated
- Fetch program with programSessions (include session data, order by weekNumber then dayOfWeek then order)
- Return 404 if not found
- Return 403 if authorId !== session.user.id
- Return program with nested sessions

**PUT /api/programs/[id]**
- Authenticated with ownership check
- Update name, description, sport, durationWeeks, difficulty, isPublic
- Only update fields that are provided (partial update)
- Return updated program with nested sessions

**DELETE /api/programs/[id]**
- Authenticated with ownership check
- Delete program (cascades to ProgramSession via schema)
- Return 204 No Content

Follow ownership pattern from src/app/api/sessions/[id]/route.ts:
- Fetch first, check authorId, return 403 if mismatch
- Use RouteContext pattern with params: Promise<{ id: string }>
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>GET/PUT/DELETE /api/programs/[id] work with ownership enforcement</done>
</task>

<task type="auto">
  <name>Task 3: Create ProgramSessions management endpoint</name>
  <files>src/app/api/programs/[id]/sessions/route.ts</files>
  <action>
Create endpoint to manage sessions within a program:

**PUT /api/programs/[id]/sessions**
- Authenticated with program ownership check
- Accepts array of session assignments:
  ```typescript
  {
    sessions: {
      sessionId: string
      weekNumber: number  // 1-based
      dayOfWeek: number   // 1-7, Monday=1
      order?: number      // for multiple sessions same day
    }[]
  }
  ```
- Use Prisma $transaction to atomically:
  1. Delete all existing ProgramSession records for this program
  2. Create new ProgramSession records from provided array
- Validate:
  - weekNumber >= 1 and <= program.durationWeeks
  - dayOfWeek >= 1 and <= 7
  - sessionId exists and belongs to the user (or is public - future consideration, for now require ownership)
- Return updated program with nested sessions
- Return 400 for validation errors

Follow transaction pattern from PUT /api/sessions/[id] (exercise replacement).
This enables drag-drop session scheduling on calendar UI.
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>PUT /api/programs/[id]/sessions atomically replaces program's session schedule</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] All 3 route files created with proper exports
</verification>

<success_criteria>
- All tasks completed
- Programs CRUD API functional
- Session scheduling via ProgramSession works
- Ownership patterns enforced consistently
</success_criteria>

<output>
After completion, create `.planning/phases/05-programs-core/05-01-SUMMARY.md`
</output>
