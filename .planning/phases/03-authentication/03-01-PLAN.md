---
phase: 03-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/auth.ts, src/app/api/auth/[...nextauth]/route.ts, prisma/schema.prisma, src/middleware.ts]
autonomous: true
---

<objective>
Configure Auth.js (NextAuth v5) with Prisma adapter and email/password credentials provider.

Purpose: Establish authentication foundation that OAuth providers will build upon.
Output: Working Auth.js setup with credentials login, database sessions, and route protection middleware.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-models/02-01-SUMMARY.md

@prisma/schema.prisma
@src/lib/db.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Auth.js and configure Prisma adapter</name>
  <files>package.json, prisma/schema.prisma, src/lib/auth.ts</files>
  <action>
1. Install dependencies: `npm install next-auth@beta @auth/prisma-adapter bcryptjs` and `npm install -D @types/bcryptjs`

2. Add Auth.js required models to prisma/schema.prisma. Auth.js with Prisma adapter requires: Account, Session (auth sessions, not our training Session), VerificationToken. Add these AFTER existing models. Update User model to include Auth.js required fields (emailVerified, image, accounts, sessions relations).

IMPORTANT: Keep our existing User fields (passwordHash, programs, sessions relations). The Auth.js fields are ADDITIONAL.

3. Create src/lib/auth.ts with Auth.js configuration:
   - Import PrismaAdapter from @auth/prisma-adapter
   - Import prisma from @/lib/db
   - Configure credentials provider with email/password
   - Password verification using bcryptjs.compare against User.passwordHash
   - Use database strategy for sessions (not JWT) for better security
   - Export auth, signIn, signOut from next-auth

4. Run `npx prisma db push` to sync schema changes
5. Run `npx prisma generate` to regenerate client

Auth.js v5 (beta) uses the new configuration pattern - NOT the old [...nextauth].ts pages router pattern.
  </action>
  <verify>
- `npm run build` succeeds (no TypeScript errors)
- prisma/schema.prisma has Account, Session (auth), VerificationToken models
- src/lib/auth.ts exports auth configuration
  </verify>
  <done>Auth.js configured with Prisma adapter, credentials provider ready, database models synced</done>
</task>

<task type="auto">
  <name>Task 2: Create Auth.js API route handler</name>
  <files>src/app/api/auth/[...nextauth]/route.ts</files>
  <action>
Create Next.js App Router API route for Auth.js at src/app/api/auth/[...nextauth]/route.ts

The route handler should:
1. Import handlers from the auth configuration (src/lib/auth.ts)
2. Export GET and POST handlers from Auth.js

Auth.js v5 pattern for App Router:
```
import { handlers } from "@/lib/auth"
export const { GET, POST } = handlers
```

This enables all Auth.js endpoints:
- GET/POST /api/auth/signin
- GET/POST /api/auth/signout
- GET /api/auth/session
- GET/POST /api/auth/callback/*
  </action>
  <verify>
- File exists at src/app/api/auth/[...nextauth]/route.ts
- `npm run build` succeeds
- curl http://localhost:3000/api/auth/session returns JSON (empty session or null)
  </verify>
  <done>Auth.js API routes operational at /api/auth/*</done>
</task>

<task type="auto">
  <name>Task 3: Create authentication middleware for route protection</name>
  <files>src/middleware.ts</files>
  <action>
Create src/middleware.ts using Auth.js middleware pattern:

1. Import auth from @/lib/auth
2. Export auth as default middleware (Auth.js v5 pattern)
3. Configure matcher to protect routes that require authentication

Protected routes pattern for SportPlan:
- /dashboard/* - user dashboard
- /sessions/new - create session
- /programs/new - create program
- /profile/* - user profile management

Public routes (no auth required):
- / - homepage
- /login, /register - auth pages
- /api/auth/* - auth endpoints
- /programs/* (viewing) - public program browsing
- /sessions/* (viewing) - public session browsing

Use config.matcher to specify which paths run through middleware.
  </action>
  <verify>
- src/middleware.ts exists with Auth.js configuration
- `npm run build` succeeds
- Protected routes redirect to signin when not authenticated
  </verify>
  <done>Route protection middleware configured for authenticated sections</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Prisma schema includes Account, Session, VerificationToken models
- [ ] Auth.js configuration exports auth, signIn, signOut, handlers
- [ ] API route handler at /api/auth/[...nextauth] exists
- [ ] Middleware protects /dashboard, /sessions/new, /programs/new routes
</verification>

<success_criteria>
- All tasks completed
- Auth.js foundation ready for credentials and OAuth providers
- Database session strategy configured
- Route protection active
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-01-SUMMARY.md`
</output>
