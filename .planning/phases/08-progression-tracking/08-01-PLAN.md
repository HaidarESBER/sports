---
phase: 08-progression-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [prisma/schema.prisma, src/app/api/workouts/route.ts, src/app/api/workouts/[id]/route.ts, src/app/api/workouts/stats/route.ts]
autonomous: true
---

<objective>
Create database models and API endpoints for workout logging and history tracking.

Purpose: Enable users to record completed training sessions with actual performance data (weights, reps, duration, etc.) and retrieve their workout history.
Output: WorkoutLog model in schema, CRUD API at /api/workouts, stats endpoint at /api/workouts/stats
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@prisma/schema.prisma
@src/app/api/sessions/route.ts
@src/app/api/sessions/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkoutLog and WorkoutExercise models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add new models to track completed workouts.

WorkoutLog model:
- id: String @id @default(cuid())
- userId: String (relation to User)
- sessionId: String? (optional - link to template session used)
- programId: String? (optional - link to program if part of program)
- name: String (workout name, can be auto-filled from session)
- sport: String
- completedAt: DateTime @default(now())
- duration: Int? (actual duration in minutes)
- notes: String? (user notes about the workout)
- rating: Int? (1-5 how it went)
- createdAt: DateTime @default(now())

WorkoutExercise model (actual performed exercises):
- id: String @id @default(cuid())
- workoutLogId: String
- exerciseId: String
- order: Int @default(0)
- plannedSets: Int? (from template)
- plannedReps: Int? (from template)
- actualSets: Int? (what was done)
- actualReps: Int? (what was done, can be JSON array like "[10,10,8]")
- weight: Float? (in kg)
- duration: Int? (seconds)
- distance: Int? (meters)
- notes: String?

Add relations:
- User has many WorkoutLogs
- WorkoutLog belongs to User, optionally to Session and Program
- WorkoutLog has many WorkoutExercises
- WorkoutExercise belongs to WorkoutLog and Exercise

After editing schema, run: npx prisma migrate dev --name add-workout-logging
  </action>
  <verify>npx prisma validate succeeds, migration completes</verify>
  <done>WorkoutLog and WorkoutExercise models added with proper relations</done>
</task>

<task type="auto">
  <name>Task 2: Create workouts list and create endpoint</name>
  <files>src/app/api/workouts/route.ts</files>
  <action>
Create GET and POST endpoints for /api/workouts.

GET /api/workouts:
- Requires auth
- Returns user's workout logs ordered by completedAt desc
- Query params for filtering:
  - sport: filter by sport type
  - from/to: date range (ISO strings)
  - sessionId: filter by template session
  - programId: filter by program
  - page/limit: pagination (default page=1, limit=20, max=100)
- Include: exercises with exercise details, session name if linked
- Return: { workouts, total, page, totalPages }

POST /api/workouts:
- Requires auth
- Body: { sessionId?, programId?, name, sport, duration?, completedAt?, notes?, rating?, exercises: [] }
- exercises array: [{ exerciseId, order, plannedSets?, plannedReps?, actualSets?, actualReps?, weight?, duration?, distance?, notes? }]
- If sessionId provided, auto-fill name/sport from session and copy planned values
- Validate: name required, sport required
- Create WorkoutLog with exercises in transaction
- Return created workout with status 201
  </action>
  <verify>curl POST creates workout, GET returns list with pagination</verify>
  <done>Workouts list and create endpoints functional with filtering</done>
</task>

<task type="auto">
  <name>Task 3: Create single workout endpoint</name>
  <files>src/app/api/workouts/[id]/route.ts</files>
  <action>
Create GET, PUT, DELETE endpoints for /api/workouts/[id].

GET /api/workouts/[id]:
- Requires auth
- Return workout with all exercises and exercise details
- Include linked session/program info if available
- Return 404 if not found or not owned by user

PUT /api/workouts/[id]:
- Requires auth
- Update workout details and/or exercises
- Use transaction for atomic update if exercises changed
- Body: { name?, sport?, duration?, completedAt?, notes?, rating?, exercises?: [] }
- Return 403 if not owner

DELETE /api/workouts/[id]:
- Requires auth
- Delete workout and all exercises (cascade)
- Return 403 if not owner
- Return 204 on success
  </action>
  <verify>curl GET/PUT/DELETE work correctly with proper authorization</verify>
  <done>Single workout CRUD endpoints with ownership validation</done>
</task>

<task type="auto">
  <name>Task 4: Create workout stats endpoint</name>
  <files>src/app/api/workouts/stats/route.ts</files>
  <action>
Create GET /api/workouts/stats endpoint for aggregate statistics.

Query params:
- period: 'week' | 'month' | 'year' | 'all' (default 'month')
- sport: filter by sport (optional)

Statistics to calculate:
- totalWorkouts: count of workouts in period
- totalDuration: sum of durations in minutes
- averageDuration: average workout duration
- workoutsBySport: { [sport]: count }
- workoutsPerWeek: average workouts per week in period
- streak: current consecutive days with workouts
- longestStreak: longest consecutive days ever
- lastWorkout: date of most recent workout
- personalRecords: array of { exerciseId, exerciseName, metric, value, date }
  - Track PRs for: max weight, max reps, max duration, max distance per exercise

Implementation notes:
- Use Prisma groupBy and aggregate functions where possible
- Calculate streak by iterating through workout dates
- For PRs, compare current maxes vs historical
- Return: { period, stats: { ... } }
  </action>
  <verify>curl returns stats object with all calculated metrics</verify>
  <done>Stats endpoint returns comprehensive workout statistics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Prisma schema validates and migration applied
- [ ] POST /api/workouts creates workout with exercises
- [ ] GET /api/workouts returns paginated list with filters
- [ ] GET /api/workouts/[id] returns single workout with details
- [ ] PUT /api/workouts/[id] updates workout
- [ ] DELETE /api/workouts/[id] removes workout
- [ ] GET /api/workouts/stats returns statistics
- [ ] All endpoints require authentication
- [ ] npm run build succeeds
</verification>

<success_criteria>
- All tasks completed
- Workout logging API fully functional
- Stats calculation working
- Proper authorization on all endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/08-progression-tracking/08-01-SUMMARY.md`
</output>
